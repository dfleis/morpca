library(devtools)
install_github("dfleis/morpca")

library(morpca)

#==========================#
#===== set parameters =====#
#==========================#
n1 <- 500 # rows
n2 <- 600 # columns
r <- 5 # r must be <= min(n1, n2)

SIGMA <- diag(rep(1, r))
gamma <- 0.2

step_size <- 0.5 # step size
step_max <- 10 # max nb of steps

#========================#
#===== generate data ====#
#========================#
X <- matrix(rnorm(n1 * n2), nrow = n1)
svd_X <- svd(X)
U <- svd_X$u[,1:r]
V <- svd_X$v[,1:r]

Y0 <- U %*% SIGMA %*% t(V)
Y <- apply(Y0, 2, function(y) {y[sample(n1, 25)] <- rnorm(25); y})

#=====================================#
#=============== TESTS ===============#
#=====================================#
pt <- proc.time()
L <- morpca(Y = Y, r = r, gamma = gamma,
            retraction = "projective",
            step_size  = step_size,
            step_max   = step_max,
            steps_out  = T)
proc.time() - pt

err <- sapply(L, function(l) 0.5 * sum(percentile_threshold(l - Y, gamma)^2))
plot(err, log = 'y', type = 'l')


X <- matrix(rnorm(5 * 3), nrow = 5)
percentile_threshold(X, 0.5)
percentile_threshold2(X, 0.5)
riemann_gradient_cpp(A, A)




